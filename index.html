<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/dark/main.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script src="https://js.arcgis.com/4.33/"></script>

<style>
    /* --- ROOT VARIABLES --- */
    .seahorse-map-container {
        --brand-blue: #0367a1;
        --panel-bg: rgba(3, 103, 161, 0.90); 
        --panel-border: rgba(255, 255, 255, 0.2);
        --text-main: #ffffff;
        --text-muted: #e0f2fe;
        --accent-gold: #fbbf24;
        --danger: #ef4444;
        font-family: 'Inter', sans-serif;
        color: var(--text-main);
        box-sizing: border-box;
        position: relative;
        width: 100%;
        margin: 0;
        padding: 0;
        height: 600px; 
        overflow: hidden;
    }

    /* --- LAYOUT SPECS --- */
    #viewDiv {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: var(--brand-blue);
        z-index: 0;
        outline: none;
    }

    /* --- LEGEND SIDEBAR --- */
    #legendSidebar {
        position: absolute;
        z-index: 10;
        background-color: var(--panel-bg);
        color: #fff;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
        border: 1px solid var(--panel-border);
        border-radius: 12px; 
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        width: 90%;
        left: 5%;
        bottom: 20px;
        top: auto;
        right: auto;
        height: 40%;
    }

    /* --- DETAIL PANEL --- */
    #detailPanel {
        position: absolute;
        top: 20px;
        left: 20px;
        width: calc(100% - 40px);
        max-width: 400px;
        height: calc(100% - 40px);
        background-color: var(--panel-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        z-index: 20;
        transform: translateX(-120%);
        transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        display: flex;
        flex-direction: column;
    }

    #detailPanel.active {
        transform: translateX(0);
    }

    /* --- LOADING SCREEN --- */
    #loadingDiv {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(3, 103, 161, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        font-family: 'Inter', sans-serif;
        font-size: 16px;
        text-align: center;
        color: white;
    }

    /* --- LEGEND INTERNAL STYLING --- */
    .sidebar-header {
        padding: 18px;
        border-bottom: 1px solid var(--panel-border);
        background: rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        border-radius: 12px 12px 0 0;
    }

    .search-wrapper {
        position: relative;
        width: 100%;
    }

    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border: 2px solid var(--text-muted);
        border-radius: 50%;
        pointer-events: none;
        opacity: 0.7;
    }
    .search-icon::after {
        content: '';
        position: absolute;
        right: -5px;
        bottom: -5px;
        width: 6px;
        height: 2px;
        background: var(--text-muted);
        transform: rotate(45deg);
    }

    #legendSearch {
        width: 100%;
        padding: 10px 10px 10px 38px;
        background-color: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-family: 'Inter', sans-serif;
        outline: none;
        box-sizing: border-box;
    }
    #legendSearch:focus {
        background-color: rgba(0,0,0,0.4);
        border-color: white;
    }

    #legendItems {
        flex: 1;
        overflow-y: auto; 
        padding: 14px 10px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        margin-bottom: 4px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        position: relative;
    }
    .legend-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
    }

    /* --- NEW INTERACTIVE HOVER EFFECT --- */
    .legend-item.interactive:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .legend-label-container {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .legend-symbol {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
    }

    .legend-label {
        font-size: 13.5px;
        line-height: 1.4;
        color: var(--text-muted);
        text-align: left;
    }
    .legend-label i {
        font-style: italic;
        color: var(--text-main);
        font-weight: 500;
    }

    .eye-icon {
        margin-left: 10px;
        color: rgba(255, 255, 255, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .eye-icon svg {
        width: 20px;
        height: 20px;
    }

    .status-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 700;
        margin-right: 6px;
        color: #0367a1;
        text-transform: uppercase;
    }

    .sublayer-container {
        margin-left: 16px;
        padding-left: 12px;
        border-left: 1px solid rgba(255, 255, 255, 0.2);
        display: none;
        margin-top: 2px;
    }
    .sublayer-container.expanded {
        display: block;
    }

    .legend-left {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

    .collapse-toggle {
        font-size: 14px;
        color: var(--text-muted);
        width: 14px;
        text-align: center;
        cursor: pointer;
    }

    /* --- SEARCH ACTIVE STATE --- */
    #legendSidebar.search-active .sublayer-container {
        margin-left: 0 !important;
        padding-left: 0 !important;
        border-left: none !important;
        display: block !important;
    }
    #legendSidebar.search-active .collapse-toggle { display: none; }
    #legendSidebar.search-active .legend-item { margin-left: 0 !important; }

    /* --- DETAIL PANEL CONTENT --- */
    .detail-header {
        padding: 20px;
        background: rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid var(--panel-border);
        position: relative;
        flex-shrink: 0;
        border-radius: 12px 12px 0 0;
    }
    .detail-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(0, 0, 0, 0.2);
        border: none;
        color: white;
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    .detail-close:hover { background: rgba(0, 0, 0, 0.4); }
    .detail-content { padding: 20px; overflow-y: auto; flex: 1; }
    .detail-title { font-size: 22px; font-weight: 700; color: white; margin: 0 0 6px 0; line-height: 1.2; }
    .detail-subtitle { font-style: italic; color: var(--text-muted); font-size: 14px; margin: 0; }
    .species-image-container {
        width: 100%; height: 220px; border-radius: 8px; overflow: hidden;
        background: rgba(0, 0, 0, 0.4); position: relative; border: 1px solid var(--panel-border);
        display: flex; align-items: center; justify-content: center;
    }
    .species-image { width: 100%; height: 100%; object-fit: cover; display: block; opacity: 0; transition: opacity 0.5s; }
    .species-image.loaded { opacity: 1; }
    .image-credit {
        position: absolute; bottom: 0; right: 0; background: rgba(0, 0, 0, 0.7);
        color: rgba(255, 255, 255, 0.9); font-size: 10px; padding: 4px 8px;
        border-top-left-radius: 6px; backdrop-filter: blur(2px);
    }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr; gap: 10px; margin: 20px 0; }
    .info-box { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--panel-border); border-radius: 8px; padding: 10px; }
    .info-label { font-size: 12px; text-transform: uppercase; color: var(--text-muted); display: block; margin-bottom: 4px; font-weight: 600;  }
    .info-value { font-size: 12px; color: var(--text-main); font-weight: 400; }
    .section-title {
        font-size: 12px; font-weight: 700; color: #ffffff; text-transform: uppercase;
        margin: 24px 0 10px 0; display: flex; align-items: center; gap: 8px;
    }
    .section-title::after { content: ''; flex: 1; height: 1px; background: rgba(255, 255, 255, 0.2); }
    .text-body { font-size: 14px; line-height: 1.6; color: var(--text-muted); }
    
    /* REVISED THREAT ITEM */
    .threat-item {
        display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; font-size: 13px;
        color: var(--text-main); background: rgba(255, 255, 255, 0.1); padding: 8px; border-radius: 6px;
    }
    .threat-icon {
        flex-shrink: 0;
        width: 18px;
        height: 18px;
        color: var(--accent-gold);
        margin-top: 1px;
    }

    /* REVISED CATCH LIST CARD */
    .country-card {
        display: flex; justify-content: space-between; align-items: center;
        padding: 8px 12px; margin-bottom: 8px; border-radius: 8px;
        background: rgba(255, 255, 255, 0.08); 
        border: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer; transition: all 0.2s ease;
    }
    .country-card:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateX(4px);
        border-color: rgba(255, 255, 255, 0.3);
    }
    .country-name { font-size: 14px; font-weight: 500; color: #fff; }
    .country-meta { display: flex; align-items: center; gap: 10px; }
    .count-badge {
        background: rgba(3, 103, 161, 0.4); border: 1px solid #0367a1;
        color: #fbbf24; padding: 2px 8px; border-radius: 12px;
        font-size: 11px; font-weight: 700;
    }
    .card-chevron { color: rgba(255, 255, 255, 0.3); font-size: 12px; }

    .chart-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 12px; }
    .chart-label { width: 100px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; text-align: right; flex-shrink: 0; }
    .chart-bar-wrapper { flex: 1; height: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 4px; overflow: hidden; display: flex; }
    .chart-val { margin-left: 8px; width: 40px; color: var(--text-main); font-size: 11px; }
    .legend-swatch { width: 10px; height: 10px; border-radius: 2px; display: inline-block; margin-right: 6px; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }

    /* --- RESPONSIVE BREAKPOINT (Desktop) --- */
    @media only screen and (min-width:768px) {
        #viewDiv { width: 100%; }
        #legendSidebar {
            top: 20px; right: 20px; left: auto; bottom: auto;
            width: 310px; height: auto; max-height: calc(100% - 40px);
            border-radius: 12px; 
        }
        #loadingDiv { width: 100%; }
    }
</style>

<div class="seahorse-map-container">
    <div id="loadingDiv">
        <div>Loading Seahorse Atlas (we need to confirm the name)...<br>(It can take up to 10 seconds)</div>
    </div>

    <div id="viewDiv">
        <div id="detailPanel">
            <div class="detail-header">
                <button class="detail-close" id="closeDetail" title="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <div id="detailHeaderContent"></div>
            </div>
            <div class="detail-content" id="detailBody"></div>
        </div>
        
        <div id="legendSidebar">
            <div class="sidebar-header">
                <div class="search-wrapper">
                    <div class="search-icon"></div>
                    <input type="text" id="legendSearch" placeholder="Search species and status..." autocomplete="off">
                </div>
            </div>
            <div id="legendItems"></div>
        </div>
    </div>


    <script type="module">
        import WebMap from "https://js.arcgis.com/4.33/@arcgis/core/WebMap.js";
        import MapView from "https://js.arcgis.com/4.33/@arcgis/core/views/MapView.js";
        import Legend from "https://js.arcgis.com/4.33/@arcgis/core/widgets/Legend.js";
        import Expand from "https://js.arcgis.com/4.33/@arcgis/core/widgets/Expand.js";

        (async () => {

            // --- DATASETS ---
            const catchData = [{country:"Argentina",gear:"Bottom trawls (nei)",count:1},{country:"Argentina",gear:"Diving",count:1},{country:"Argentina",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Australia",gear:"Bottom trawls (nei)",count:10},{country:"Australia",gear:"Diving",count:3},{country:"Australia",gear:"Gear nei",count:1},{country:"Azores Islands (Portugal)",gear:"Gear not known",count:1},{country:"Bangladesh",gear:"Bottom trawls (nei)",count:1},{country:"Bangladesh",gear:"Pushnets",count:1},{country:"Bangladesh",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Bangladesh",gear:"Stationary uncovered pound nets",count:1},{country:"Belgium",gear:"Bottom trawls (nei)",count:1},{country:"Belgium",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Belgium",gear:"Traps (nei)",count:1},{country:"Belgium",gear:"Gear not known",count:1},{country:"Belize",gear:"Bottom trawls (nei)",count:1},{country:"Belize",gear:"Diving",count:1},{country:"Brazil",gear:"Bottom trawls (nei)",count:14},{country:"Brazil",gear:"Diving",count:5},{country:"Brazil",gear:"Gear nei",count:4},{country:"Brazil",gear:"Beach seines",count:3},{country:"Brazil",gear:"Cast nets",count:3},{country:"Brazil",gear:"Gillnets and entangling nets (nei)",count:2},{country:"Brazil",gear:"Set gillnets (anchored)",count:2},{country:"Brazil",gear:"Barriers, fences, weirs, etc.",count:2},{country:"Brazil",gear:"Gear not known",count:2},{country:"Brazil",gear:"Seine nets (nei)",count:1},{country:"Brazil",gear:"Pots",count:1},{country:"Cambodia",gear:"Bottom trawls (nei)",count:2},{country:"Cambodia",gear:"Gear nei",count:1},{country:"Cambodia",gear:"Pushnets",count:1},{country:"Cambodia",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Cambodia",gear:"Fyke nets",count:1},{country:"Cambodia",gear:"Pots",count:1},{country:"Cambodia",gear:"Traps (nei)",count:1},{country:"Chile",gear:"Bottom trawls (nei)",count:1},{country:"China",gear:"Bottom trawls (nei)",count:4},{country:"China",gear:"Gear not known",count:2},{country:"China",gear:"Gillnets and entangling nets (nei)",count:1},{country:"China",gear:"Cast nets",count:1},{country:"Costa Rica",gear:"Diving",count:2},{country:"Costa Rica",gear:"Bottom trawls (nei)",count:1},{country:"Costa Rica",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Croatia",gear:"Gear not known",count:1},{country:"Ecuador",gear:"Bottom trawls (nei)",count:2},{country:"Ecuador",gear:"Diving",count:2},{country:"Ecuador",gear:"Beach seines",count:1},{country:"Ecuador",gear:"Purse seines",count:1},{country:"France",gear:"Bottom trawls (nei)",count:3},{country:"France",gear:"Stationary uncovered pound nets",count:1},{country:"Gambia",gear:"Bottom trawls (nei)",count:2},{country:"Gambia",gear:"Diving",count:1},{country:"Gambia",gear:"Hand implements (Wrenching gear, Clamps, Tongs, Rakes, Spears)",count:1},{country:"Gambia",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Gambia",gear:"Set gillnets (anchored)",count:1},{country:"Gambia",gear:"Beach seines",count:1},{country:"Gambia",gear:"Seine nets (nei)",count:1},{country:"Gambia",gear:"Pots",count:1},{country:"Gambia",gear:"Traps (nei)",count:1},{country:"Gambia",gear:"Cast nets",count:1},{country:"Gambia",gear:"Handlines and hand-operated pole-and-lines",count:1},{country:"Germany",gear:"Traps (nei)",count:3},{country:"Germany",gear:"Bottom trawls (nei)",count:1},{country:"Greece",gear:"Bottom trawls (nei)",count:2},{country:"Greece",gear:"Boat seines",count:1},{country:"Guatemala",gear:"Bottom trawls (nei)",count:2},{country:"Guatemala",gear:"Trammel nets",count:1},{country:"Honduras",gear:"Bottom trawls (nei)",count:2},{country:"Honduras",gear:"Trammel nets",count:1},{country:"Honduras",gear:"Seine nets (nei)",count:1},{country:"Hong Kong SAR",gear:"Gear not known",count:1},{country:"India",gear:"Bottom trawls (nei)",count:10},{country:"India",gear:"Diving",count:5},{country:"India",gear:"Gear nei",count:3},{country:"India",gear:"Gillnets and entangling nets (nei)",count:3},{country:"India",gear:"Beach seines",count:3},{country:"India",gear:"Seine nets (nei)",count:2},{country:"India",gear:"Traps (nei)",count:2},{country:"India",gear:"Surrounding nets (nei)",count:2},{country:"India",gear:"Drift gillnets",count:1},{country:"India",gear:"Set gillnets (anchored)",count:1},{country:"India",gear:"Trammel nets",count:1},{country:"India",gear:"Barriers, fences, weirs, etc.",count:1},{country:"India",gear:"Cast nets",count:1},{country:"India",gear:"Falling gear (nei)",count:1},{country:"India",gear:"Purse seines",count:1},{country:"India",gear:"Hooks and lines (nei)",count:1},{country:"Indonesia",gear:"Bottom trawls (nei)",count:3},{country:"Indonesia",gear:"Diving",count:3},{country:"Indonesia",gear:"Gear not known",count:3},{country:"Indonesia",gear:"Gear nei",count:2},{country:"Indonesia",gear:"Pushnets",count:2},{country:"Indonesia",gear:"Beach seines",count:2},{country:"Indonesia",gear:"Scoopnets",count:1},{country:"Indonesia",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Indonesia",gear:"Barriers, fences, weirs, etc.",count:1},{country:"Indonesia",gear:"Pots",count:1},{country:"Indonesia",gear:"Cast nets",count:1},{country:"Indonesia",gear:"Purse seines",count:1},{country:"Indonesia",gear:"Lift nets (nei)",count:1},{country:"Italy",gear:"Bottom trawls (nei)",count:3},{country:"Italy",gear:"Gear nei",count:3},{country:"Italy",gear:"Gear not known",count:3},{country:"Italy",gear:"Beach seines",count:2},{country:"Italy",gear:"Harpoons",count:1},{country:"Italy",gear:"Trammel nets",count:1},{country:"Italy",gear:"Pots",count:1},{country:"Italy",gear:"Purse seines",count:1},{country:"Japan",gear:"Bottom trawls (nei)",count:1},{country:"Kenya",gear:"Bottom trawls (nei)",count:1},{country:"Kenya",gear:"Diving",count:1},{country:"Kenya",gear:"Seine nets (nei)",count:1},{country:"Kenya",gear:"Cast nets",count:1},{country:"Kenya",gear:"Purse seines",count:1},{country:"Kuwait",gear:"Bottom trawls (nei)",count:1},{country:"Malaysia",gear:"Bottom trawls (nei)",count:10},{country:"Malaysia",gear:"Drift gillnets",count:4},{country:"Malaysia",gear:"Gear nei",count:3},{country:"Malaysia",gear:"Cast nets",count:3},{country:"Malaysia",gear:"Purse seines",count:3},{country:"Malaysia",gear:"Diving",count:1},{country:"Malaysia",gear:"Pushnets",count:1},{country:"Malaysia",gear:"Scoopnets",count:1},{country:"Malaysia",gear:"Trammel nets",count:1},{country:"Malaysia",gear:"Seine nets (nei)",count:1},{country:"Malaysia",gear:"Barriers, fences, weirs, etc.",count:1},{country:"Malaysia",gear:"Pots",count:1},{country:"Malaysia",gear:"Stationary uncovered pound nets",count:1},{country:"Malaysia",gear:"Stow nets",count:1},{country:"Malaysia",gear:"Traps (nei)",count:1},{country:"Malaysia",gear:"Hooks and lines (nei)",count:1},{country:"Mexico",gear:"Bottom trawls (nei)",count:4},{country:"Mexico",gear:"Diving",count:3},{country:"Mexico",gear:"Hand implements (Wrenching gear, Clamps, Tongs, Rakes, Spears)",count:1},{country:"Mexico",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Mexico",gear:"Set gillnets (anchored)",count:1},{country:"Mexico",gear:"Beach seines",count:1},{country:"Mexico",gear:"Boat seines",count:1},{country:"Mexico",gear:"Pots",count:1},{country:"Mexico",gear:"Cast nets",count:1},{country:"Mozambique",gear:"Beach seines",count:1},{country:"Mozambique",gear:"Purse seines",count:1},{country:"Netherlands",gear:"Bottom trawls (nei)",count:1},{country:"New Zealand",gear:"Bottom trawls (nei)",count:2},{country:"New Zealand",gear:"Longlines (nei)",count:1},{country:"Nicaragua",gear:"Bottom trawls (nei)",count:2},{country:"Nicaragua",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Nigeria",gear:"Bottom trawls (nei)",count:1},{country:"Norway",gear:"Bottom trawls (nei)",count:1},{country:"Norway",gear:"Pots",count:1},{country:"Oman",gear:"Traps (nei)",count:1},{country:"Pakistan",gear:"Bottom trawls (nei)",count:1},{country:"Pakistan",gear:"Diving",count:1},{country:"Pakistan",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Panama",gear:"Diving",count:2},{country:"Panama",gear:"Bottom trawls (nei)",count:1},{country:"Peru",gear:"Bottom trawls (nei)",count:3},{country:"Peru",gear:"Diving",count:3},{country:"Peru",gear:"Gillnets and entangling nets (nei)",count:3},{country:"Peru",gear:"Set gillnets (anchored)",count:1},{country:"Peru",gear:"Trammel nets",count:1},{country:"Peru",gear:"Purse seines",count:1},{country:"Philippines",gear:"Diving",count:10},{country:"Philippines",gear:"Bottom trawls (nei)",count:5},{country:"Philippines",gear:"Gear nei",count:5},{country:"Philippines",gear:"Pushnets",count:4},{country:"Philippines",gear:"Beach seines",count:2},{country:"Philippines",gear:"Seine nets (nei)",count:2},{country:"Philippines",gear:"Barriers, fences, weirs, etc.",count:2},{country:"Philippines",gear:"Pots",count:2},{country:"Philippines",gear:"Drift gillnets",count:1},{country:"Philippines",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Philippines",gear:"Set gillnets (anchored)",count:1},{country:"Philippines",gear:"Boat seines",count:1},{country:"Philippines",gear:"Traps (nei)",count:1},{country:"Philippines",gear:"Cover pots/Lantern nets",count:1},{country:"Philippines",gear:"Gear not known",count:1},{country:"Portugal",gear:"Bottom trawls (nei)",count:2},{country:"Portugal",gear:"Beach seines",count:2},{country:"Portugal",gear:"Pushnets",count:1},{country:"Portugal",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Portugal",gear:"Trammel nets",count:1},{country:"Portugal",gear:"Pots",count:1},{country:"Portugal",gear:"Traps (nei)",count:1},{country:"Senegal",gear:"Bottom trawls (nei)",count:2},{country:"Senegal",gear:"Diving",count:1},{country:"Senegal",gear:"Hand implements (Wrenching gear, Clamps, Tongs, Rakes, Spears)",count:1},{country:"Senegal",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Senegal",gear:"Set gillnets (anchored)",count:1},{country:"Senegal",gear:"Beach seines",count:1},{country:"Senegal",gear:"Seine nets (nei)",count:1},{country:"Senegal",gear:"Pots",count:1},{country:"Senegal",gear:"Traps (nei)",count:1},{country:"Senegal",gear:"Cast nets",count:1},{country:"Senegal",gear:"Handlines and hand-operated pole-and-lines",count:1},{country:"South Korea",gear:"Seine nets (nei)",count:1},{country:"South Korea",gear:"Purse seines",count:1},{country:"South Korea",gear:"Gear not known",count:1},{country:"Spain",gear:"Gear nei",count:2},{country:"Spain",gear:"Bottom trawls (nei)",count:1},{country:"Spain",gear:"Seine nets (nei)",count:1},{country:"Spain",gear:"Gear not known",count:1},{country:"Sri Lanka",gear:"Bottom trawls (nei)",count:1},{country:"Sri Lanka",gear:"Gear nei",count:1},{country:"Sri Lanka",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Sri Lanka",gear:"Fyke nets",count:1},{country:"Sweden",gear:"Pots",count:1},{country:"Taiwan",gear:"Bottom trawls (nei)",count:1},{country:"Taiwan",gear:"Gear not known",count:1},{country:"Tanzania",gear:"Bottom trawls (nei)",count:2},{country:"Tanzania",gear:"Gear nei",count:2},{country:"Tanzania",gear:"Seine nets (nei)",count:2},{country:"Tanzania",gear:"Purse seines",count:2},{country:"Tanzania",gear:"Diving",count:1},{country:"Tanzania",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Tanzania",gear:"Beach seines",count:1},{country:"Tanzania",gear:"Pots",count:1},{country:"Tanzania",gear:"Traps (nei)",count:1},{country:"Tanzania",gear:"Cast nets",count:1},{country:"Tanzania",gear:"Surrounding nets (nei)",count:1},{country:"Thailand",gear:"Bottom trawls (nei)",count:7},{country:"Thailand",gear:"Gillnets and entangling nets (nei)",count:4},{country:"Thailand",gear:"Pushnets",count:3},{country:"Thailand",gear:"Diving",count:2},{country:"Thailand",gear:"Pots",count:1},{country:"Thailand",gear:"Purse seines",count:1},{country:"Tunisia",gear:"Gillnets and entangling nets (nei)",count:1},{country:"Tunisia",gear:"Dredges (nei)",count:1},{country:"Turkey",gear:"Bottom trawls (nei)",count:5},{country:"Turkey",gear:"Gillnets and entangling nets (nei)",count:4},{country:"Turkey",gear:"Gear nei",count:2},{country:"Turkey",gear:"Purse seines",count:2},{country:"Turkey",gear:"Gear not known",count:2},{country:"Turkey",gear:"Beach seines",count:1},{country:"United Arab Emirates",gear:"Midwater trawls (nei)",count:1},{country:"United Kingdom",gear:"Bottom trawls (nei)",count:2},{country:"United Kingdom",gear:"Gillnets and entangling nets (nei)",count:1},{country:"United Kingdom",gear:"Pots",count:1},{country:"United States",gear:"Bottom trawls (nei)",count:5},{country:"United States",gear:"Beach seines",count:2},{country:"United States",gear:"Gillnets and entangling nets (nei)",count:1},{country:"United States",gear:"Gear not known",count:1},{country:"Uruguay",gear:"Fyke nets",count:1},{country:"Viet Nam",gear:"Bottom trawls (nei)",count:9},{country:"Viet Nam",gear:"Diving",count:6},{country:"Viet Nam",gear:"Electric fishing",count:1},{country:"Viet Nam",gear:"Set gillnets (anchored)",count:1},{country:"Viet Nam",gear:"Boat seines",count:1},{country:"Viet Nam",gear:"Pots",count:1},{country:"Viet Nam",gear:"Traps (nei)",count:1}];
            const gearColors = ["#3b82f6", "#06b6d4", "#14b8a6", "#84cc16", "#f59e0b", "#ef4444", "#8b5cf6", "#ec4899", "#6366f1", "#9ca3af"];
            
            const manualImageOverrides = { 
                "Hippocampus zosterae": {url: "https://static.inaturalist.org/photos/1164927/large.jpg", iucnLink: "https://www.iucnredlist.org/species/10089/46910143", attribution: "Kent Miller / iNaturalist"},
                "Hippocampus abdominalis": {url: "https://static.inaturalist.org/photos/1164927/large.jpg", iucnLink: "https://www.iucnredlist.org/species/10057/54903879", attribution: "D. Maynard / iNaturalist"},
                "Hippocampus patagonicus": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/165496598/original.jpg", iucnLink: "https://www.iucnredlist.org/species/195100/54909767", attribution: "Gonzalo Bravo / iNaturalist"},
                "Hippocampus subelongatus": {url: "https://static.inaturalist.org/photos/1873652/large.jpg", iucnLink: "https://www.iucnredlist.org/species/40773/54906710", attribution: "Daniël Messom/ iNaturalist"},
                "Hippocampus whitei": {url: "https://static.inaturalist.org/photos/12009596/large.jpg", iucnLink: "https://www.iucnredlist.org/species/10088/46721312", attribution: "Samantha De Smet / iNaturalist"},
                "Hippocampus erectus": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/391235678/large.jpg", iucnLink: "https://www.iucnredlist.org/species/10066/20191442", attribution: "Pauline Walsh Jacobson / iNaturalist"},
                "Hippocampus dahli": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/391235678/large.jpg", iucnLink: "https://www.iucnredlist.org/species/101729662/103206102", attribution: "Pauline Walsh Jacobson / iNaturalist"},
                "Hippocampus algiricus": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/592647296/large.jpg", iucnLink: "https://www.iucnredlist.org/species/41007/54907846", attribution: "Dennis Rabeling / iNaturalist"},
                "Hippocampus ingens": {url: "https://static.inaturalist.org/photos/12112505/large.jpg", iucnLink: "https://www.iucnredlist.org/species/10072/54905720", attribution: "Joshua Feingold / iNaturalist"},
                "Hippocampus hippocampus": {url: "https://static.inaturalist.org/photos/49805056/large.jpg", iucnLink: "https://www.iucnredlist.org/species/10069/67618259", attribution: "Janny Bosman / iNaturalist"},
                "Hippocampus bargibanti": {url: "https://static.inaturalist.org/photos/49731161/large.jpg", iucnLink: "https://www.iucnredlist.org/species/10060/250508253", attribution: "Marc Van Buynder / iNaturalist"},
                "Hippocampus denise": {url: "https://static.inaturalist.org/photos/49840052/large.jpg", iucnLink: "https://www.iucnredlist.org/species/41716/247789834", attribution: "Valerie Debruyne / iNaturalist"},
                "Hippocampus satomiae": {url: "https://static.inaturalist.org/photos/49629697/large.jpg", iucnLink: "https://www.iucnredlist.org/species/250584311/250593114", attribution: "Barbara Moll / iNaturalist"},
                "Hippocampus nalu": {url: "https://static.inaturalist.org/photos/49833424/large.jpg", iucnLink: "https://www.iucnredlist.org/species/250584311/250593114", attribution: "Pedro Ferreira / iNaturalist"},
                "Hippocampus comes": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/336623495/large.jpg", iucnLink: "https://www.iucnredlist.org/species/41008/128958172", attribution: "Franck Fogarolo / iNaturalist"},
                "Hippocampus fisheri": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/336623503/medium.jpg", iucnLink: "https://www.iucnredlist.org/species/41009/54908481", attribution: "Boris Mekler / iNaturalist"},
                "Hippocampus reidi": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/336623503/medium.jpg", iucnLink: "https://www.iucnredlist.org/species/10082/17025021", attribution: "Ernst Seeling / iNaturalist"},
                "Hippocampus haema": {url: "https://static.inaturalist.org/photos/49634367/medium.jpg", iucnLink: "https://www.iucnredlist.org/species/250584055/250593104", attribution: "Zhang Jinggong / iNaturalist"},
                "Hippocampus japapigu": {url: "https://upload.wikimedia.org/wikipedia/commons/c/c2/Hippocampus_japapigu_%2810.3897-zookeys.779.24799%29_Figure_4.jpg", iucnLink: "https://www.iucnredlist.org/species/250584194/250593109", attribution: "Richard Smith / iNaturalist"},
                "Hippocampus trimaculatus": {url: "https://static.inaturalist.org/photos/49835402/medium.jpg", iucnLink: "https://www.iucnredlist.org/species/10087/17252219", attribution: "Caron Wong / iNaturalist"},
                "Hippocampus guttulatus": {url: "https://static.inaturalist.org/photos/2100424/original.jpg", iucnLink: "https://www.iucnredlist.org/species/41006/67617766", attribution: "Edwin van der Sande / iNaturalist"},
                "Hippocampus waleananus": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/9829337/large.jpg", iucnLink: "https://www.iucnredlist.org/species/250584632/250593119", attribution: "Reto Piere / iNaturalist"},
                "Hippocampus debelius": {iucnLink: "https://www.iucnredlist.org/species/47728610/242659051"},
                "Hippocampus angustus": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/42104659/large.jpg", iucnLink: "https://www.iucnredlist.org/species/107261486/54907188", attribution: "Alexandra Hoschke / iNaturalist"},
                "Hippocampus breviceps": {url: "https://inaturalist-open-data.s3.amazonaws.com/photos/78304319/large.jpg", iucnLink: "https://www.iucnredlist.org/species/10063/54904334", attribution: "Paul Sorensen / iNaturalist"},
                "Hippocampus minotaur": {iucnLink: "https://www.iucnredlist.org/species/10077/54906067"},
                "Hippocampus paradoxus": {iucnLink: "https://www.iucnredlist.org/species/65368181/67622595"},
                "Hippocampus planifrons": {iucnLink: "https://www.iucnredlist.org/species/68527310/47728827"},
                "Hippocampus zebra": {iucnLink: "https://www.iucnredlist.org/species/107261083/54906819"}
            };

            const seizureData = [{c:"Viet Nam",exp:243412.6,imp:617992.1,tr:80520.45},{c:"China",exp:113723,imp:1705997,tr:27881.04},{c:"Hong Kong SAR",exp:116349.1,imp:523960.5,tr:1028.535},{c:"India",exp:221765.4,imp:25118.11,tr:92852.31},{c:"Philippines",exp:215936.9,imp:96394.46,tr:21561.34},{c:"Peru",exp:1885832,imp:0,tr:443494.1},{c:"Thailand",exp:30271.61,imp:24140.37,tr:5204.461},{c:"Egypt",exp:156245.1,imp:18587.36,tr:15241.64},{c:"Indonesia",exp:113961.3,imp:557.6208,tr:0},{c:"Mozambique",exp:39464.68,imp:0,tr:3345.725},{c:"Malaysia",exp:316.4758,imp:11152.42,tr:7040},{c:"Mexico",exp:17222.09,imp:947,tr:531},{c:"Nepal",exp:15241.64,imp:0,tr:5204.461},{c:"UAE",exp:0,imp:22118.96,tr:7806.691},{c:"Panama",exp:0,imp:20000,tr:0},{c:"China (Macau)",exp:0,imp:19702.6,tr:0},{c:"France",exp:0,imp:54,tr:20952},{c:"Bolivia",exp:0,imp:0,tr:23258.33},{c:"Germany",exp:0,imp:53,tr:16248},{c:"Belgium",exp:0,imp:15,tr:13551},{c:"Netherlands",exp:0,imp:0,tr:6624.494},{c:"South Africa",exp:496.6543,imp:132,tr:7434.944}];

            const speciesInfo = {
                "Hippocampus abdominalis": { status: "LC", common: "Pot-bellied seahorse" },
                "Hippocampus algiricus": { status: "VU", common: "West African seahorse" },
                "Hippocampus angustus": { status: "LC", common: "Narrow-bellied seahorse" },
                "Hippocampus barbouri": { status: "VU", common: "Barbour's seahorse" },
                "Hippocampus bargibanti": { status: "LC", common: "Bargibant's seahorse" },
                "Hippocampus breviceps": { status: "LC", common: "Short-head seahorse" },
                "Hippocampus camelopardalis": { status: "DD", common: "Giraffe seahorse" },
                "Hippocampus capensis": { status: "EN", common: "Knysna seahorse" },
                "Hippocampus casscsio": { status: "DD", common: "Casscsio’s seahorse" },
                "Hippocampus colemani": { status: "DD", common: "Coleman's pygmy seahorse" },
                "Hippocampus coronatus": { status: "VU", common: "Crowned seahorse" },
                "Hippocampus dahli": { status: "LC", common: "Lowcrown seahorse" },
                "Hippocampus debelius": { status: "NT", common: "Softcoral seahorse" },
                "Hippocampus denise": { status: "LC", common: "Denise's pygmy seahorse" },
                "Hippocampus comes": { status: "EN", common: "Tiger tail seahorse" },
                "Hippocampus erectus": { status: "NT", common: "Lined seahorse" },
                "Hippocampus fisheri": { status: "LC", common: "Fisher's seahorse" },
                "Hippocampus guttulatus": { status: "NT", common: "Long-snouted seahorse" },
                "Hippocampus haema": { status: "VU", common: "Korean seahorse" },
                "Hippocampus hippocampus": { status: "LC", common: "Short-snouted seahorse" },
                "Hippocampus histrix": { status: "VU", common: "Thorny seahorse" },
                "Hippocampus ingens": { status: "EN", common: "Giant seahorse" },
                "Hippocampus japapigu": { status: "LC", common: "Japanese pygmy seahorse" },
                "Hippocampus jayakari": { status: "LC", common: "Jayakar's seahorse" },
                "Hippocampus jugumus": { status: "DD", common: "Collared seahorse" },
                "Hippocampus kelloggi": { status: "DD", common: "Great seahorse" },
                "Hippocampus kuda": { status: "VU", common: "Spotted seahorse" },
                "Hippocampus minotaur": { status: "DD", common: "Bullneck seahorse" },
                "Hippocampus mohnikei": { status: "VU", common: "Japanese seahorse" },
                "Hippocampus nalu": { status: "NT", common: "Sodwana pygmy seahorse" },
                "Hippocampus paradoxus": { status: "DD", common: "Paradoxical seahorse" },
                "Hippocampus patagonicus": { status: "EN", common: "Patagonian seahorse" },
                "Hippocampus planifrons": { status: "LC", common: "Flatface seahorse" },
                "Hippocampus pontohi": { status: "LC", common: "Pontoh's pgymy seahorse" },
                "Hippocampus pusillus": { status: "LC", common: "Dwarf thorny seahorse" },
                "Hippocampus reidi": { status: "VU", common: "Long-snout seahorse" },
                "Hippocampus satomiae": { status: "LC", common: "Satomi's seahorse" },
                "Hippocampus sindonis": { status: "LC", common: "Sindo's seahorse" },
                "Hippocampus spinosissimus": { status: "VU", common: "Hedgehog seahorse" },
                "Hippocampus subelongatus": { status: "LC", common: "Western Australian seahorse" },
                "Hippocampus trimaculatus": { status: "EN", common: "Three-spot seahorse" },
                "Hippocampus tyro": { status: "DD", common: "Tyro seahorse" },
                "Hippocampus waleananus": { status: "CR", common: "Walea soft coral pygmy seahorse" },
                "Hippocampus whitei": { status: "EN", common: "White's seahorse" },
                "Hippocampus zebra": { status: "LC", common: "Zebra seahorse" },
                "Hippocampus zosterae": { status: "LC", common: "Dwarf seahorse" }
            };

            const speciesDatabase = {
                "Hippocampus algiricus": {previous: {status: "VU", year: 2016}, updated: {status: "N/A"}, habitat: "Coastal areas with silt, mud, gravel, sand, seagrass, macroalgae, coral reefs and estuaries", threats: ["Bycatch by multiple fishing gear", "Habitat degradation", " Traditional medicine trade"], trend: "Decreasing", size: 22, depth: "0-25"},
                "Hippocampus nalu": {previous: {status: "NT", year: 2023}, updated: {status: "N/A"}, habitat: "Sandy, sandstone-based coral reefs", threats: ["Habitat degradation"], trend: "Decreasing", size: 2.2, depth: "12-17"},
                "Hippocampus fisheri": {previous: {status: "LC", year: 2016}, updated: {status: "N/A"}, habitat: "Pelagic waters", threats: ["Coastal development", "Water pollution"], trend: "Stable", size: 8, depth: "0-110"},
                "Hippocampus patagonicus": {previous: {status: "VU", year: 2016}, updated: {status: "EN", year: "under review"}, habitat: "Algae, seagrass, artificial structures, sessile invertebrates and estuaries", threats: ["Bycatch by multiple fishing gear", "Habitat degradation", "Water pollution"], trend: "Decreasing", size: 15.5, depth: "0-120"},
                "Hippocampus zosterae": {previous: {status: "LC", year: 2016}, updated: {status: "N/A"}, habitat: "Seagrass bed and submerged vegetation", threats: ["Habitat degradation", "Aquarium and curios trades"], trend: "Stable", size: 5.4},
                "Hippocampus guttulatus": {previous: {status: "DD", year: 2016}, updated: {status: "NT", year: "under review"}, habitat: "Coastal lagoons, estuaries, seagrass meadows, macroalgae, rock reefs, artificial structures", threats: ["Bycatch by multiple fishing gear", "Habitat degradation"], trend: "Decreasing", size: 18, depth: "0-30"},
                "Hippocampus hippocampus": {previous: {status: "DD", year: 2017}, updated: {status: "LC", year: "under review"}, habitat: "Soft sediment, rocky bottoms, seagrass meadows, macroalgae, artificial structures, lagoons and estuaries", threats: ["Bycatch by multiple fishing gear", "Habitat degradation"], trend: "Decreasing", size: 15, depth: "0-60"},
                "Hippocampus abdominalis": {previous: {status: "LC", year: 2016}, updated: {status: "N/A"}, habitat: "Coastal waters, harbors, rocky reefs, macroalgal bed, loose gravel, seagrass and artificial structures", threats: ["Bycatch by multiple fishing gear", "Habitat degradation", "Harmful algal bloom"], trend: "Stable", size: 35, depth: "0-104"},
                "Hippocampus angustus": {previous: {status: "LC", year: 2016}, updated: {status: "N/A"}, habitat: "Soft bottom substrate, coral reefs", threats: ["Bycatch by multiple fishing gear", "Habitat degradation"], trend: "Stable", size: 16, depth: "0-63"},
                "Hippocampus breviceps": {previous: {status: "LC", year: 2016}, updated: {status: "N/A"}, habitat: "Macroalgal beds, seagrass, coral and rocky reefs, and estuaries", threats: ["Habitat degradation", "Harmful algal bloom"], trend: "Stable", size: 10, depth: "0-15"},
                "Hippocampus dahli": {previous: {status: "LC", year: 2016}, updated: {status: "N/A"}, habitat: "Estuary channels, gravel and soft substrates", threats: ["Bycatch by multiple fishing gear", "Habitat degradation"], trend: "Stable", size: 14, depth: "Unknown"},
                "Hippocampus minotaur": {previous: {status: "DD", year: 2016}, updated: {status: "N/A"}, habitat: "Sandy and hard bottoms, and soft corals", threats: ["Bottom bycatch", "Habitat degradation"], trend: "Unknown", size: 5, depth: "64-110"},
                "Hippocampus paradoxus": {previous: {status: "DD", year: 2016}, updated: {status: "N/A"}, habitat: "Shell benthos, sand with sponges and bryozoans", threats: ["Bycatch by multiple fishing gear"], trend: "Unknown", size: 6.5, depth: "94-110"},
                "Hippocampus planifrons": {previous: {status: "LC", year: 2016}, updated: {status: "N/A"}, habitat: "Rock pools, shallow algae, and weedy or rubble reefs", threats: ["Habitat degradation"], trend: "Stable", size: 11.6, depth: "0-20"},
                "Hippocampus subelongatus": {previous: {status: "DD", year: 2016}, updated: {status: "N/A"}, habitat: "Rocky reefs, seagrass beds, estuaries, macroalgae, and artificial structures", threats: ["Habitat degradation"], trend: "Stable", size: 20, depth: "0-25"},
                "Hippocampus zebra": {previous: {status: "DD", year: 2016}, updated: {status: "LC", year: "under review"}, habitat: "Soft bottoms, black corals, and gorgonians", threats: ["Bycatch by multiple fishing gear", "Habitat degradation"], trend: "Stable", size: 9, depth: "0-20"},
                "Hippocampus bargibanti": {previous: {status: "LC", year: 2023}, updated: {status: "N/A"}, habitat: "Coral reefs, specifically on muricella gorgonian sea fans", threats: ["Climate change", "Habitat degradation (Coral reef destruction)", "Tourism activities"], trend: "Decreasing", size: 2.4, depth: "4-40"},
                "Hippocampus capensis": {previous: {status: "EN", year: 2017}, updated: {status: "under review"}, habitat: "Estuaries, submerged vegetation like zostera and ruppia", threats: ["Coastal development", "Water pollution"], trend: "Decreasing", size: 12},
                "Hippocampus comes": {previous: {status: "VU", year: 2013}, updated: {status: "EN", year: "under review"}, habitat: "Coral reefs, sponge gardens, macroalgal beds, seagrass, rocky reefs, sandy and muddy bottoms, and artificial structures", threats: ["Aquarium trade", "Bycatch by multiple fishing gear", "Habitat degradation", "Traditional medicine trade"], trend: "Decreasing", size: 18.7, depth: "0-20"},
                "Hippocampus denise": {previous: {status: "LC", year: 2023}, updated: {status: "N/A"}, habitat: "Gorgonian corals", threats: ["Habitat degradation"], trend: "Decreasing", size: 2.4, depth: "13-102"},
                "Hippocampus haema": {previous: {status: "VU", year: 2023}, updated: {status: "N/A"}, habitat: "Seagrass and seaweed", threats: ["Bycatch by multiple fishing gear", "Habitat degradation"], trend: "Decreasing", size: 10, depth: "0-18"},
                "Hippocampus japapigu": {previous: {status: "LC", year: 2023}, updated: {status: "N/A"}, habitat: "Soft corals, coralline algae, Halimeda spp. and hydroids", threats: ["Habitat degradation"], trend: "Decreasing", size: 1.6, depth: "5-22"},
                "Hippocampus satomiae": {previous: {status: "NE"}, updated: {status: "LC", year: "under review"}, habitat: "Gorgonian and soft corals", threats: ["Destructive fishing practice", "Habitat degradation"], trend: "Decreasing", size: 1.4, depth: "Unknown"},
                "Hippocampus erectus": {previous: {status: "VU", year: 2016}, updated: {status: "NT", year: "under review"}, habitat: "Mangroves, coral, rocky and oyster reef habitats, macroalga, sandy bottoms, artificial structures, floating sargassum, and sponges", threats: ["Aquarium, curious and traditional medicine trades", "Bycatch by multiple fishing gear", "Habitat degradation"], trend: "Decreasing", size: 18.5, depth: "0-100"},
                "Hippocampus ingens": {previous: {status: "VU", year: 2016}, updated: {status: "EN", year: "under review"}, habitat: "Mangroves, macroalgae, seagrass and coral reefs", threats: ["Aquarium, curious and traditional medicine trades", "Bycatch by multiple fishing gear", "Habitat degradation"], trend: "Decreasing", size: 30, depth: "1-60"},
                "Hippocampus kuda": {previous: {status: "VU", year: 2017}, updated: {status: "under review"}, habitat: "Estuaries, seagrass, mangroves, muddy bottoms", threats: ["Bycatch by multiple fishing gear", "Traditional medicine bycatch"], trend: "Decreasing", size: 30},
                "Hippocampus reidi": {previous: {status: "NT", year: 2016}, updated: {status: "VU", year: "under review"}, habitat: "Bryozoans, oysters, sponges, and tunicates, gorgonian corals, seagrass, estuaries, and especially macroalgae, mangroves, sandy and muddy bottoms, and artificial structures", threats: ["Aquarium, curious and traditional medicine trades", "Bycatch by multiple fishing gear", "Habitat degradation", "Tourism activities"], trend: "Decreasing", size: 23, depth: "0-55"},
                "Hippocampus trimaculatus": {previous: {status: "VU", year: 2012}, updated: {status: "EN", year: "under review"}, habitat: "Gravel and sand bottoms, octocorals, macroalgae, sponges and seagrass bed", threats: ["Aquarium, curious and traditional medicine trades", "Bycatch by multiple fishing gear", "Habitat degradation"], trend: "Decreasing", size: 18.6, depth: "10-110"},
                "Hippocampus waleananus": {previous: {status: "CR", year: 2023}, updated: {status: "N/A"}, habitat: "Soft corals", threats: ["Habitat degradation"], trend: "Decreasing", size: 1.8, depth: "5-20"},
                "Hippocampus debelius": {previous: {status: "NT", year: 2023}, updated: {status: "N/A"}, habitat: "Soft corals", threats: ["Habitat degradation"], trend: "Decreasing", size: 3.5, depth: " Unknown "},
                "Hippocampus whitei": {previous: {status: "EN", year: 2016}, updated: {status: "N/A"}, habitat: "Seagrass, macroalgae, corals, sponges, and artificial structures", threats: ["Coastal development", "Habitat degradation"], trend: "Decreasing", size: 16.2, depth: "0-12"}
            };

            const habitatDatabase = {
                "Coral reefs": {
                    image: "https://discovery.sndimg.com/content/dam/images/discovery/fullset/2021/6/29/GettyImages-1189048716.jpg.rend.hgtvcom.1280.960.suffix/1624995019897.jpeg ",
                    desc: "Coral reefs provide essential structural complexity for many seahorse species, particularly pygmy seahorses (e.g., <i>H. bargibanti</i>, <i>H. denise</i>) which have evolved to mimic specific gorgonian corals. These habitats offer shelter from predators and currents."
                },
                "Mangroves": {
                    image: "https://www.papuaparadise.com/wp-content/uploads/2024/11/mangrove-small-fishes-1200x800-1.jpg",
                    desc: "Mangrove roots act as critical nurseries and feeding grounds for young seahorses. Species like <i>H. kuda</i> and <i>H. reidi</i> often cling to mangrove roots, relying on the murky waters and complex root systems for camouflage and protection."
                },
                "Seagrass": {
                    image: " https://www.scienceinschool.org/wp-content/uploads/2024/03/Image_1b_sunny_seagrass_Credit_Fiona-Crouch-800x600.png",
                    desc: "Seagrass meadows are one of the most common habitats for seahorses globally. The grass blades provide perfect holdfasts for their prehensile tails and excellent camouflage. Species like <i>H. zosterae</i> and <i>H. abdominalis</i> thrive here."
                }
            };

            const genericData = {
                habitat: "Coastal marine waters, often associated with seagrass, algae, or coral reefs.",
                threats: ["Habitat degradation", "Bycatch", "Climate change"],
                trend: "Unknown",
                size: " Unknown"
            };

            // --- INIT MAP ---
            const webmap = new WebMap({ portalItem: { id: "8a36f0f1a97c4389ba1b3d086ba08150" } });
            const view = new MapView({
                container: "viewDiv",
                map: webmap,
                ui: { components: ["attribution", "zoom"] },
                popup: { autoOpenEnabled: false, defaultPopupTemplateEnabled: false }
            });

            // --- API & HELPER FUNCTIONS ---
            async function fetchSpeciesImage(scientificName) {
                const override = manualImageOverrides[scientificName];
                const defaultIucnLink = `https://www.iucnredlist.org/search?query=${encodeURIComponent(scientificName)}`;
                const placeholderImage = "https://t3.ftcdn.net/jpg/10/22/24/80/360_F_1022248039_7LDxHRi3Mlt9BK3wzLBUGZp9XAO1gt2s.jpg";

                if (!override) return { url: placeholderImage, attribution: "Image not available", link: defaultIucnLink };
                return { url: override.url || placeholderImage, attribution: override.attribution || "Image not available", link: override.iucnLink || defaultIucnLink };
            }

            function getStatusColor(code) {
                const colors = { "LC": "#22c55e", "NT": "#a3e635", "VU": "#fbbf24", "EN": "#f97316", "CR": "#ef4444", "DD": "#94a3b8", "NE": "#ffffff" };
                return colors[code] || "#94a3b8";
            }

            function getStatusBadge(assessment) {
                if (!assessment || !assessment.status) return "";
                const yearHTML = assessment.year ? ` (${assessment.year})` : "";
                return `<span class="status-badge" style="background-color:${getStatusColor(assessment.status)}">${assessment.status}${yearHTML}</span>`;
            }

            // --- PANEL RENDERING LOGIC ---
            
            function showHabitatDetails(habitatName) {
                const panel = document.getElementById('detailPanel');
                const header = document.getElementById('detailHeaderContent');
                const body = document.getElementById('detailBody');
                const data = habitatDatabase[habitatName];

                if (!data) return;

                panel.classList.add('active');
                header.innerHTML = `<h2 class="detail-title">${habitatName}</h2><p class="detail-subtitle">Essential Seahorse Habitat</p>`;
                
                body.innerHTML = `
                    <div class="species-image-container">
                        <img src="${data.image}" class="species-image loaded" alt="${habitatName}">
                    </div>
                    <div class="section-title">Ecological Importance</div>
                    <p class="text-body">${data.desc}</p>
                `;
            }

            async function fetchAndShowDetails(scientificName, commonName, status) {
                const panel = document.getElementById('detailPanel');
                const header = document.getElementById('detailHeaderContent');
                const body = document.getElementById('detailBody');

                panel.classList.add('active');
                header.innerHTML = `<h2 class="detail-title">${commonName}</h2><p class="detail-subtitle">${scientificName}</p>`;
                body.innerHTML = `<div style="padding:20px; text-align:center; color:rgba(255,255,255,0.5)">Loading species data...</div>`;

                const data = speciesDatabase[scientificName] || genericData;
                const imageData = await fetchSpeciesImage(scientificName);

                let imageHTML = imageData.url ?
                    `<div class="species-image-container"><a href="${imageData.link}" target="_blank"><img src="${imageData.url}" class="species-image loaded" alt="${scientificName}" style="cursor:pointer"></a><div class="image-credit">&copy;${imageData.attribution}</div></div>` :
                    `<div class="species-image-container"><span style="font-size:12px; color:rgba(255,255,255,0.5);">Image Not Available</span></div>`;

                // YELLOW TRIANGLE SVG
                const threatIconSVG = `<svg class="threat-icon" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.044-2 5.198 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>`;

                body.innerHTML = `
                <div style="margin-bottom:20px;">${getStatusBadge({status: status})}</div>
                ${imageHTML}
                <div class="info-grid">
                    <div class="info-box" style="grid-column: 1 / span 3;"><span class="info-label">Current Assessment</span><div class="info-value"> ${getStatusBadge(data.previous)} </div></div>
                    <div class="info-box" style="grid-column: 4 / span 3;"><span class="info-label">Updated Assessment</span><div class="info-value"> ${getStatusBadge(data.updated)} </div></div>
                    <div class="info-box" style="grid-column: 1 / span 2;"><span class="info-label">Population Trend</span><div class="info-value" style="color: ${data.trend === 'Decreasing' ? '#ff6b6b' : data.trend === 'Stable' ? '#4ade80' : 'white'}; text-shadow: 0 0 6px rgba(255, 107, 107, 0.6); font-weight: 700;">${data.trend}</div></div>
                    <div class="info-box" style="grid-column: 3 / span 2;"><span class="info-label">Max Size</span><div class="info-value">${data.size} ${data.size !== 'Unknown' ? 'cm' : ''}</div></div>
                    <div class="info-box" style="grid-column: 5 / span 2;"><span class="info-label">Depth Range</span><div class="info-value">${data.depth} ${data.depth !== 'Unknown' ? 'm' : ''}</div></div>
                </div>
                <div class="section-title">Habitat</div><p class="text-body">${data.habitat}</p>
                <div class="section-title">Major Threats</div>
                <div style="margin-top:10px">
                    ${data.threats.map(t => `<div class="threat-item">${threatIconSVG}${t}</div>`).join('')}
                </div>
                `;
            }

            function showTradeData() {
                const panel = document.getElementById('detailPanel');
                const header = document.getElementById('detailHeaderContent');
                const body = document.getElementById('detailBody');

                panel.classList.add('active');
                header.innerHTML = `<h2 class="detail-title">Global Illegal Trade</h2><p class="detail-subtitle">Number of seahorses seized by jurisdiction</p>`;

                const expLayer = webmap.allLayers.find(l => l.title === "Exporter");
                const impLayer = webmap.allLayers.find(l => l.title === "Importer");
                const trLayer = webmap.allLayers.find(l => l.title === "Transit");

                const showExp = expLayer ? expLayer.visible : false;
                const showImp = impLayer ? impLayer.visible : false;
                const showTr = trLayer ? trLayer.visible : false;

                const processedData = seizureData.map(d => {
                    const currentTotal = (showExp ? d.exp : 0) + (showImp ? d.imp : 0) + (showTr ? d.tr : 0);
                    return { ...d, currentTotal };
                });

                const sorted = processedData.filter(d => d.currentTotal > 0).sort((a, b) => b.currentTotal - a.currentTotal);
                
                if (sorted.length === 0) {
                    body.innerHTML = `<div style="padding:40px; text-align:center; color:rgba(255,255,255,0.5)">
                        Toggle <b>Exporter</b>, <b>Importer</b>, or <b>Transit</b> layers to view data.
                    </div>`;
                    return;
                }

                const maxVal = sorted[0].currentTotal;

                const chartRows = sorted.map(d => {
                    const expPct = (d.exp / maxVal) * 100;
                    const impPct = (d.imp / maxVal) * 100;
                    const trPct = (d.tr / maxVal) * 100;

                    return `
                    <div class="chart-row">
                        <div class="chart-label" title="${d.c}">${d.c}</div>
                        <div class="chart-bar-wrapper">
                            ${showExp && d.exp > 0 ? `<div class="chart-bar" style="width:${expPct}%; background:#24a8e0;" title="Export: ${Math.round(d.exp)}"></div>` : ''}
                            ${showTr && d.tr > 0 ? `<div class="chart-bar" style="width:${trPct}%; background:#fbff0a;" title="Transit: ${Math.round(d.tr)}"></div>` : ''}
                            ${showImp && d.imp > 0 ? `<div class="chart-bar" style="width:${impPct}%; background:#e64c4f;" title="Import: ${Math.round(d.imp)}"></div>` : ''}
                        </div>
                        <div class="chart-val">${Math.round(d.currentTotal).toLocaleString()}</div>
                    </div>`;
                }).join('');

                body.innerHTML = `
                <div style="margin-bottom:20px; display:flex; gap:15px; justify-content:center; font-size:11px;">
                    ${showExp ? `<div style="display:flex; align-items:center; font-weight:500; font-size:14; color:#fff;"><span class="legend-swatch" style="background:#24a8e0;"></span>Export</div>` : ''}
                    ${showTr ? `<div style="display:flex; align-items:center; font-weight:500; font-size:14; color:#fff;"><span class="legend-swatch" style="background:#fbff0a;"></span>Transit</div>` : ''}
                    ${showImp ? `<div style="display:flex; align-items:center; font-weight:500; font-size:14; color:#fff;"><span class="legend-swatch" style="background:#e64c4f;"></span>Import</div>` : ''}
                </div>
                <div class="chart-container">
                    ${chartRows}
                </div>
                <p style="font-size:10px; color:#fff; margin-top:20px; text-align:center">Data source: Foster, S. J., Ascione, S. J., Santaniello, F., & Phelps Bondaroff, T. N. (2025).</p>
                `;
            }

            function showCatchData(countryName) {
                const panel = document.getElementById('detailPanel');
                const header = document.getElementById('detailHeaderContent');
                const body = document.getElementById('detailBody');

                panel.classList.add('active');
                let targetCountry = countryName;
                let filteredData = [];

                if (targetCountry) {
                    filteredData = catchData.filter(item => item.country.toLowerCase() === targetCountry.toLowerCase());
                    if (filteredData.length === 0) {
                        const candidates = catchData.filter(d =>
                            d.country.toLowerCase().includes(targetCountry.toLowerCase()) ||
                            targetCountry.toLowerCase().includes(d.country.toLowerCase())
                        );
                        if (candidates.length > 0) {
                            targetCountry = candidates[0].country;
                            filteredData = catchData.filter(item => item.country === targetCountry);
                        } else {
                            targetCountry = null;
                        }
                    }
                }

                if (!targetCountry) {
                    header.innerHTML = `<h2 class="detail-title">Reported catch of seahorse</h2><p class="detail-subtitle">Select a jurisdiction to view the list of fishing gear that reportedly caught seahorse</p>`;
                    const uniqueCountries = [...new Set(catchData.map(d => d.country))];
                    const countryStats = uniqueCountries.map(c => {
                        const count = catchData.filter(d => d.country === c).length;
                        return { name: c, count: count };
                    }).sort((a, b) => a.name.localeCompare(b.name));
                    
                    const listHtml = countryStats.map(stat => `
                    <div class="country-card" data-country="${stat.name}">
                        <div class="country-name" style="font-size:12px;">${stat.name}</div>
                        <div class="country-meta">
                            <span class="count-badge">${stat.count} types</span>
                            <span class="card-chevron">&#10095;</span>
                        </div>
                    </div>
                    `).join('');

                    body.innerHTML = `
                        <div id="countryListContainer" style="padding-bottom:10px;">${listHtml}</div>
                        <div style="font-size:10px; color:#fff; text-align:center; padding:15px; border-top:1px solid rgba(255,255,255,0.1);">
                            Data source: McPherson, et al. (unpublished)
                        </div>
                    `;
                    
                    const container = document.getElementById('countryListContainer');
                    if(container) {
                        container.querySelectorAll('.country-card').forEach(item => {
                            item.addEventListener('click', (e) => { showCatchData(item.dataset.country); });
                        });
                    }
                    return;
                }

                header.innerHTML = `<h2 class="detail-title" style="font-size:22px; margin-bottom:2px;">${targetCountry}</h2><button id="backToCountryList" style="margin-top:8px; background:none; border:1px solid rgba(255,255,255,0.3); padding:4px 8px; color:white; border-radius:4px; cursor:pointer; font-size:14px;">&#8678; Back</button>`;

                const agg = {};
                filteredData.forEach(d => {
                    let name = d.gear.replace(/\s*\(.*?\)\s*/g, '').trim();
                    if (name.length > 30) name = name.substring(0, 28) + "...";
                    agg[name] = (agg[name] || 0) + d.count;
                });

                const chartData = Object.keys(agg).map((key, i) => ({
                    label: key, value: agg[key], color: gearColors[i % gearColors.length]
                })).sort((a, b) => b.value - a.value);

                const maxCount = chartData.length > 0 ? chartData[0].value : 1;
                const listHtml = chartData.map((item, index) => {
                    const widthPct = (item.value / maxCount) * 100;
                    return `
                        <div style="margin-bottom:12px;">
                            <div style="display:flex; justify-content:space-between; align-items:flex-end; font-size:12px; color:#e0f2fe; margin-bottom:2px;">
                                <div style="line-height:1.1;">${index === 0 ? `<div style=" font-weight:500; font-size:12px; color: #ffffff; margin-bottom:10px;">Gear type</div>` : ``}<div>${item.label}</div></div>
                                <div style="text-align:right; line-height:1.1;">${index === 0 ? `<div style=" font-weight:500; font-size:12px; color: #ffffff; margin-bottom:10px;">Number of sources</div>` : ``}<div style=" color:white; font-size:12px;">${item.value}</div></div>
                            </div>
                            <div style="height:8px; background:rgba(255,255,255,0.1); border-radius:4px; overflow:hidden;"><div style="height:100%; width:${widthPct}%; background:${item.color}; border-radius:4px;"></div></div>
                        </div>`;
                }).join('');
                
                body.innerHTML = `<div style="background:rgba(0,0,0,0.25); padding:20px; border-radius:10px; border:1px solid rgba(255,255,255,0.05);"><div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">${listHtml}</div></div>`;
                const btn = document.getElementById('backToCountryList');
                if(btn) btn.addEventListener('click', () => showCatchData(null));
            }

            document.getElementById('closeDetail').addEventListener('click', () => {
                document.getElementById('detailPanel').classList.remove('active');
            });


            // --- MAIN VIEW LOGIC ---
            view.when().then(() => {
                document.getElementById('loadingDiv').style.display = 'none';

                view.ui.move("zoom", "top-left");
                view.popup.dockOptions = { buttonEnabled: false, breakpoint: false, position: "bottom-left" };
                view.constraints = { minZoom: 1, maxZoom: 12, snapToZoom: false, rotationEnabled: true };

                // --- LEGEND GENERATION ---
                function addLayerToLegend(layer, container, level = 0) {
                    if (layer.title === "Seahorse species_by depth") return;

                    const item = document.createElement("div");
                    item.className = "legend-item";

                    // --- CHECK IF LAYER IS INTERACTIVE ---
                    const isInteractive = speciesInfo[layer.title] || 
                                          habitatDatabase[layer.title] || 
                                          ["Exporter", "Importer", "Transit", "Seahorse seizures", "Reported catch jurisdictions"].includes(layer.title);
                    
                    if (isInteractive) {
                        item.classList.add("interactive");
                    }

                    const collapseToggle = document.createElement("div");
                    collapseToggle.className = "collapse-toggle";
                    collapseToggle.textContent = layer.type === "group" ? "+" : "";

                    const labelContainer = document.createElement("div");
                    labelContainer.className = "legend-label-container";

                    const symbol = document.createElement("div");
                    symbol.className = "legend-symbol";

                    if (layer.type !== "group") {
                        const customSymbols = {
                            "Exporter": "#24a8e0", "Transit": "#fbff0a", "Importer": "#e64c4f",
                            "Coral reefs": "#e64e4e", "Seagrass": "#4ccd75", "Mangroves": "#736e1c",
                            "Hippocampus abdominalis": "#e64e4e", "Hippocampus algiricus": "#4c81cd",
                            "Hippocampus breviceps": "#4c81cd", "Hippocampus minotaur": "#f68efa",
                            "Hippocampus paradoxus": "#cdbb4c", "Hippocampus subelongatus": "#949494",
                            "Hippocampus whitei": "#4ccd75", "Hippocampus debelius": "#eb7a7c",
                            "Hippocampus comes": "#ba82e8", "Hippocampus haema": "#ec7a78",
                            "Hippocampus japapigu": "#c970a7", "Hippocampus satomiae": "#7b9ee1",
                            "Hippocampus trimaculatus": "#69a880", "Hippocampus waleananus": "#fc7e43",
                            "Hippocampus nalu": "#79d998", "Hippocampus hippocampus": "#eb7e79",
                            "Hippocampus guttulatus": "#fdea7e", "Hippocampus angustus": "#cf6eaa",
                            "Hippocampus dahli": "#93d9e5", "Hippocampus planifrons": "#f97f47",
                            "Hippocampus zebra": "#6c678f", "Hippocampus bargibanti": "#98d7e9",
                            "Hippocampus erectus": "#ca72a6", "Hippocampus fisheri": "#74a2dd",
                            "Hippocampus ingens": "#ed7a7d", "Hippocampus patagonicus": "#94dbde",
                            "Hippocampus reidi": "#88cf99", "Hippocampus zosterae": "#b882e1",
                            "Hippocampus denise": "#fcec7d", "Reported catch jurisdictions": "#a8a8a8",
                            "Seahorse seizures": "#a8a8a8"
                        };
                        const color = customSymbols[layer.title] || "#ccc";
                        if (color.startsWith("linear-gradient")) symbol.style.background = color;
                        else symbol.style.backgroundColor = color;

                        if (layer.title === "Reported catch jurisdictions") {
                            layer.opacity = 0.6;
                            layer.visible = true;
                        } else if (layer.title !== "Ocean Basemap" && layer.title !== "World Hillshade" && layer.title !== "Seahorse seizures") {
                            layer.visible = false;
                        }
                    } else {
                        symbol.style.display = 'none';
                    }

                    const label = document.createElement("div");
                    label.className = "legend-label";
                    if (speciesInfo[layer.title]) {
                        const info = speciesInfo[layer.title];
                        const badgeHTML = info.status ? `<span class="status-badge" style="background-color: ${getStatusColor(info.status)}">${info.status}</span>` : "";
                        label.innerHTML = `<i>${layer.title}</i><div style="margin-top:2px; font-size:13px; opacity:0.8">${badgeHTML} ${info.common}</div>`;
                    } else {
                        label.textContent = layer.title;
                    }

                    labelContainer.appendChild(symbol);
                    labelContainer.appendChild(label);

                    const leftContainer = document.createElement("div");
                    leftContainer.className = "legend-left";
                    if (layer.type === "group") leftContainer.appendChild(collapseToggle);
                    leftContainer.appendChild(labelContainer);

                    const eye = document.createElement("div");
                    eye.className = "eye-icon";
                    const getEyeSVG = (visible) => visible ?
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>' :
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';

                    eye.innerHTML = getEyeSVG(layer.visible);
                    item.appendChild(leftContainer);
                    item.appendChild(eye);
                    container.appendChild(item);

                    // --- AUTO-TOGGLE LOGIC ---
                    eye.addEventListener("click", e => {
                        e.stopPropagation();
                        
                        const newVisible = !layer.visible;
                        layer.visible = newVisible;
                        eye.innerHTML = getEyeSVG(newVisible);

                        // Sync Parent
                        if (newVisible && layer.parent && layer.parent.type === "group" && !layer.parent.visible) {
                            layer.parent.visible = true;
                            const parentContainer = container.closest('.sublayer-container');
                            if(parentContainer) {
                                const parentItem = parentContainer.previousElementSibling;
                                if(parentItem) {
                                    const parentEye = parentItem.querySelector('.eye-icon');
                                    if(parentEye) parentEye.innerHTML = getEyeSVG(true);
                                }
                            }
                        }

                        // Sync Children
                        const updateModelVisibility = (parent) => {
                            if (parent.layers && (parent.layers.items || Array.isArray(parent.layers))) {
                                const children = parent.layers.items || parent.layers;
                                children.forEach(c => {
                                    c.visible = newVisible;
                                    updateModelVisibility(c);
                                });
                            }
                        };
                        updateModelVisibility(layer);

                        // Sync DOM Children
                        if (layer.type === "group") {
                            const subContainer = item.nextElementSibling;
                            if (subContainer && subContainer.classList.contains("sublayer-container")) {
                                const childEyes = subContainer.querySelectorAll(".eye-icon");
                                childEyes.forEach(childEye => {
                                    childEye.innerHTML = getEyeSVG(newVisible);
                                });
                            }
                        }

                        // --- TRIGGER CHART UPDATE IF NEEDED ---
                        const panelTitle = document.querySelector('.detail-title');
                        if (panelTitle && panelTitle.textContent === "Global Illegal Trade") {
                            if (["Exporter", "Importer", "Transit", "Seahorse seizures"].includes(layer.title) || layer.title === "Seahorse seizures") {
                                showTradeData();
                            }
                        }
                    });

                    label.addEventListener("click", async e => {
                        e.stopPropagation();
                        try {
                            label.style.color = "var(--accent-gold)";
                            setTimeout(() => label.style.color = "", 500);
                            
                            layer.visible = true;
                            eye.innerHTML = getEyeSVG(true);
                            
                            if (layer.parent && layer.parent.type === "group" && !layer.parent.visible) {
                                layer.parent.visible = true;
                                const parentContainer = container.closest('.sublayer-container');
                                if(parentContainer) {
                                    const parentItem = parentContainer.previousElementSibling;
                                    if(parentItem) {
                                        const parentEye = parentItem.querySelector('.eye-icon');
                                        if(parentEye) parentEye.innerHTML = getEyeSVG(true);
                                    }
                                }
                            }

                            await layer.load();
                            if (layer.fullExtent) await view.goTo(layer.fullExtent.expand(1.2));
                            else if (layer.extent) await view.goTo(layer.extent.expand(1.2));

                            if (["Exporter", "Importer", "Transit", "Seahorse seizures"].includes(layer.title)) {
                                showTradeData();
                            } else if (layer.title === "Reported catch jurisdictions") {
                                showCatchData(null);
                            } else if (speciesInfo[layer.title]) {
                                const info = speciesInfo[layer.title];
                                fetchAndShowDetails(layer.title, info.common, info.status);
                            } else if (habitatDatabase[layer.title]) {
                                showHabitatDetails(layer.title);
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    });

                    if (layer.type === "group") {
                        const subContainer = document.createElement("div");
                        subContainer.className = "sublayer-container";
                        container.appendChild(subContainer);
                        item.addEventListener("click", e => {
                            if (e.target.closest(".eye-icon")) return;
                            const isExpanded = subContainer.classList.toggle("expanded");
                            collapseToggle.textContent = isExpanded ? "–" : "+";
                        });
                        const sorted = [...layer.layers.items].sort((a, b) => a.title.localeCompare(b.title));
                        sorted.forEach(l => addLayerToLegend(l, subContainer, level + 1));
                    }
                }

                const legendContainer = document.getElementById("legendItems");
                legendContainer.innerHTML = "";

                const getLayerPriority = (layer) => {
                    const t = layer.title;
                    if ((t.toLowerCase().includes("species") || speciesInfo[t]) && !t.includes("depth")) return 1;
                    if (t.includes("Reported catch")) return 2;
                    if (t.includes("seizure") || t.includes("Seizure") || t.includes("Trade") || ["Exporter", "Importer", "Transit"].includes(t)) return 3;
                    return 4;
                };

                const sortedLayers = [...webmap.layers.items].sort((a, b) => {
                    const pA = getLayerPriority(a);
                    const pB = getLayerPriority(b);
                    if (pA !== pB) return pA - pB;
                    return webmap.layers.indexOf(b) - webmap.layers.indexOf(a);
                });

                sortedLayers.forEach(layer => addLayerToLegend(layer, legendContainer));

                // --- CLICK HANDLER ---
                view.on("click", async (event) => {
                    view.popup.close();

                    const response = await view.hitTest(event);
                    if (response.results.length === 0) return;

                    const hit = response.results.find(r => {
                        const g = r.graphic;
                        if (!g || !g.layer) return false;
                        const title = g.layer.title;
                        if (speciesInfo[title]) return true;
                        if (habitatDatabase[title]) return true;
                        if (["Exporter", "Importer", "Transit"].includes(title)) return true;
                        if (title === "Reported catch jurisdictions") return true;
                        return false;
                    });

                    if (!hit) return;

                    const graphic = hit.graphic;
                    const title = graphic.layer.title;

                    if (speciesInfo[title]) {
                        const info = speciesInfo[title];
                        fetchAndShowDetails(title, info.common, info.status);
                    } else if (habitatDatabase[title]) {
                        showHabitatDetails(title);
                    } else if (title === "Reported catch jurisdictions") {
                        const attr = graphic.attributes;
                        const candidates = [
                            attr.country, attr.Country, attr.COUNTRY, attr.name, attr.Name, attr.NAME,
                            attr.cntry_name, attr.CNTRY_NAME, attr.Cntry_Name, attr.sovereignt, attr.SOVEREIGNT, attr.admin, attr.ADMIN
                        ];
                        const country = candidates.find(c => c && typeof c === "string");
                        showCatchData(country);
                    } else if (["Exporter", "Importer", "Transit"].includes(title)) {
                        showTradeData();
                    }
                });

                // --- SEARCH LOGIC ---
                const searchBox = document.getElementById("legendSearch");
                const sidebar = document.getElementById("legendSidebar");
                searchBox.addEventListener("input", () => {
                    const query = searchBox.value.trim().toLowerCase();
                    const isSearching = query.length > 0;
                    if (isSearching) {
                        sidebar.classList.add("search-active");
                    } else {
                        sidebar.classList.remove("search-active");
                        document.querySelectorAll(".legend-item, .sublayer-container").forEach(el => el.style.display = "");
                        return;
                    }
                    const setDisplay = (el, show) => el.style.display = show ? "flex" : "none";

                    function searchItem(item) {
                        const label = item.querySelector(".legend-label");
                        const subContainer = item.nextElementSibling;
                        if (!label) return false;
                        const text = label.textContent;
                        let selfMatch = text.toLowerCase().includes(query);
                        let childMatch = false;
                        if (subContainer && subContainer.classList.contains("sublayer-container")) {
                            Array.from(subContainer.children).forEach(subItem => {
                                if (subItem.classList.contains("legend-item")) {
                                    if (searchItem(subItem)) childMatch = true;
                                }
                            });
                        }
                        const isVisible = selfMatch || childMatch;
                        setDisplay(item, isVisible);
                        return isVisible;
                    }
                    Array.from(document.querySelectorAll("#legendItems > .legend-item")).forEach(searchItem);
                });

            }); // End view.when
        })();
    </script>
</div>

